<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Image Magick Legacy</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: sans-serif;
            margin: 50px 50px 600px 50px;
        }
        input[type=number] {
            width: 60px;
            text-align: right;
        }
        input[type=radio], input[type=checkbox] {
            display: inline-block;
            margin-right: 5px;
        }
        #palette {
            line-height: 34px;
        }
        .color {
            display: inline-block;
            margin-right: 7px;
        }
        .color .square {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 1px solid white;
            vertical-align: -3px;
            margin-right: 3px;
        }
        h2 {
            border-top: 1px solid white;
            line-height: 40px;
        }
        #kernelPreview {
            border: 1px solid silver;
        }
        .fixedWidth {
            display: inline-block;
            width: 50px;
            text-align: right;
            background-color: white;
            color: black;
            padding: 1px 3px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="imagick.js"></script>
    <script src="im.js"></script>
    <script>

        let onResizeButton = () => {
            IMCmdResize($('#src'), $('#width').val(), $('#height').val(), $('#filters').val(), $('#resized'));
        };
        let onCharcoalButton = () => {
            IMCharcoal($('#src'), $('#charcoalRadius').val(), $('#charcoalSigma').val(), $('#charcoaled'));
        };
        let onSketchButton = () => {
            IMSketch($('#src'), $('#sketchRadius').val(), $('#sketchSigma').val(), $('#sketchAngle').val(), $('#sketched'));
        };
        let onQuantizeButton = () => {
            IMQuantize($('#src'), $('#quantizeNumber').val(), IMEnumColorspaces.indexOf($('#quantizeColorSpace').val()), $('#quantizeTreeDepth').val(), $('#quantizeDither').is(':checked'), $('#quantizeErrorCorrection').is(':checked'), $('#quantized'));
        };
        let onQuantizeListButton = () => {
            let colors = IMQuantizeAndListUniqueColors($('#src'), $('#quantizeListNumber').val());
            if (!Array.isArray(colors)) return;
            $('#quantizeListNumberColors').text('('+colors.length+' color'+(colors.length>1?'s':'')+')');
            let $container = $('#quantizeListPalette');
            $container.empty();
            for (color of colors) {
                let $color = $('<span class="color" />');
                let $square = $('<span class="square" />');
                let rgb_string = 'rgb('+color.join(',')+')';
                $square.css('background-color', rgb_string);
                $color.text(rgb_string);
                $color.prepend($square);
                $container.append($color);
            }
        };
        let onQuantizedLoaded = () => {
            let colors = IMListUniqueColors($('#quantized'));
            if (!Array.isArray(colors)) return;
            $('#numberColors').text('('+colors.length+' color'+(colors.length>1?'s':'')+')');
            let $container = $('#palette');
            $container.empty();
            for (color of colors) {
                let $color = $('<span class="color" />');
                let $square = $('<span class="square" />');
                $square.css('background-color', color);
                $color.text(color);
                $color.prepend($square);
                $container.append($color);
            }
        };
        let onColorButton = () => {
            IMColors($('#src'), $('#colorNumber').val(), $('#colorDither').val(), $('#colored'));
        };
        let onColoredLoaded = () => {
            let colors = IMListUniqueColors($('#colored'));
            if (!Array.isArray(colors)) return;
            $('#colorNumberColors').text('('+colors.length+' color'+(colors.length>1?'s':'')+')');
            let $container = $('#colorPalette');
            $container.empty();
            for (color of colors) {
                let $color = $('<span class="color" />');
                let $square = $('<span class="square" />');
                $square.css('background-color', color);
                $color.text(color);
                $color.prepend($square);
                $container.append($color);
            }
        };
        let onPosterizeButton = () => {
            IMPosterize($('#src'), $('#posterizeLevels').val(), $('#posterized'));
        };
        let onPosterizedLoaded = () => {
            let colors = IMListUniqueColors($('#posterized'));
            if (!Array.isArray(colors)) return;
            $('#posterizeNumberColors').text('('+colors.length+' color'+(colors.length>1?'s':'')+')');
            let $container = $('#posterizePalette');
            $container.empty();
            for (color of colors) {
                let $color = $('<span class="color" />');
                let $square = $('<span class="square" />');
                $square.css('background-color', color);
                $color.text(color);
                $color.prepend($square);
                $container.append($color);
            }
        };
        let onAutolevelButton = () => {
            IMAutoLevel($('#src'), $('#autoleveled'), IMEnumChannels[$('#alChannels').val()]);
        };
        let onAutogammaButton = () => {
            IMAutoGamma($('#src'), $('#autogammaed'), IMEnumChannels[$('#agChannels').val()]);
        };
        let onContrastButton = () => {
            let increase = $('input[name=contrastRadio]:checked').val();
            IMContrast($('#src'), $('#contrasted'), increase);
        };
        let onSigmoidalContrastButton = () => {
            IMSigmoidalContrast($('#src'), $('input[name=sigmoidalContrastRadio]:checked').val()==1?0:1, $('#sigmoidalContrast').val(), $('#sigmoidalContrastMidPoint').val(), $('#sigmoidalContrasted'));
        };
        let onSourceChange = () => {
            $('#src').attr('src', $('#source').val());
        };
        let onKernelParamsChange = () => {
            let $morphologyKernel = $('#morphologyKernel');
            let $morphologyKernelParams = $('#morphologyKernelParams');
            let $kernelPreview = $('#kernelPreview');
            $kernelPreview.attr('src', 'kernpresets/kern_' + $morphologyKernel.val() + '-' + $morphologyKernelParams.val() + '.gif');
        }
        let onKernelChange = () => {
            let $morphologyKernel = $('#morphologyKernel');
            let $morphologyKernelParams = $('#morphologyKernelParams');
            let k = $morphologyKernel.val();
            $morphologyKernelParams.empty();
            for (const params of IMEnumKernels[k]) {
                let $opt = $('<option />');
                $opt.val(params);
                $opt.text(params);
                $morphologyKernelParams.append($opt);
            }
            onKernelParamsChange();
        }
        let onMorphologyButton = () => {
            IMMorphology($('#src'), $('#morphologyMethod').val(), $('#morphologyKernel').val() + ':' +  $('#morphologyKernelParams').val(), $('#morphologied'));
        }
        let onExposureButton = () => {
            IMExposure($('#src'), parseFloat($('#exposureStops').val()), parseFloat($('#exposureOffset').val()), parseFloat($('#exposureGamma').val()), $('#exposured'));
        }
        let onGlowButton = () => {
            IMGlow($('#src'), parseFloat($('#glowAmount').val()), parseInt($('#glowSoftening').val()), $('#glowed'));
        }
        let onIMReady = () => {
            let $filters = $('#filters');
            const sortedFilters = [...IMEnumFilters].sort();
            for (const filter of sortedFilters) {
                let $opt = $('<option />');
                $opt.val(filter);
                $opt.text(filter);
                if (filter === 'Default') $opt.prop('selected', true);
                $filters.append($opt);
            }
            for (const channelsId of ['#alChannels', '#agChannels']) {
                let $channels = $(channelsId);
                for (channel of Object.keys(IMEnumChannels)) {
                    let $opt = $('<option />');
                    $opt.val(channel);
                    $opt.text(channel);
                    if (channel === 'RGB') $opt.prop('selected', true);
                    $channels.append($opt);
                }
            }
            let $ditherSelect = $('#colorDither');
            for (const dither of Object.keys(IMEnumDithers)) {
                let $opt = $('<option />');
                $opt.val(dither);
                $opt.text(IMEnumDithers[dither][2]);
                if (dither === 'FloydSteinberg') $opt.prop('selected', true);
                $ditherSelect.append($opt);
            }
            let $quantizeColorSpace = $('#quantizeColorSpace');
            for (const colorspace of IMEnumColorspaces) {
                let $opt = $('<option />');
                $opt.val(colorspace);
                $opt.text(colorspace);
                if (colorspace === 'sRGB') $opt.prop('selected', true);
                $quantizeColorSpace.append($opt);
            }
            let $morphologyMethod = $('#morphologyMethod');
            for (const method of IMEnumMorphologies) {
                let $opt = $('<option />');
                $opt.val(method);
                $opt.text(method);
                if (method === 'Dilate') $opt.prop('selected', true);
                $morphologyMethod.append($opt);
            }
            let $morphologyKernel = $('#morphologyKernel');
            for (const kernel of Object.keys(IMEnumKernels)) {
                let $opt = $('<option />');
                $opt.val(kernel);
                $opt.text(kernel);
                $morphologyKernel.append($opt);
                if (kernel === 'Octagon') {
                    $opt.prop('selected', true);
                    onKernelChange();
                }
            }
            $('#exposureStops').on('input', () => {
                $('#exposureStopsDisplay').text($('#exposureStops').val());
            });
            $('#exposureOffset').on('input', () => {
                $('#exposureOffsetDisplay').text($('#exposureOffset').val());
            });
            $('#exposureGamma').on('input', () => {
                $('#exposureGammaDisplay').text($('#exposureGamma').val());
            });
            $('#glowAmount').on('input', () => {
                $('#glowAmountDisplay').text($('#glowAmount').val());
            });
            $('#glowSoftening').on('input', () => {
                $('#glowSofteningDisplay').text($('#glowSoftening').val());
            });
            $('#glowButton').on('click', onGlowButton);
            $('#exposureButton').on('click', onExposureButton);
            $morphologyKernel.on('change', onKernelChange);
            $('#morphologyKernelParams').on('change', onKernelParamsChange);
            $('#resizeButton').on('click', onResizeButton);
            $('#charcoalButton').on('click', onCharcoalButton);
            $('#sketchButton').on('click', onSketchButton);
            $('#quantized').on('load', onQuantizedLoaded);
            $('#quantizeButton').on('click', onQuantizeButton);
            $('#quantizeListButton').on('click', onQuantizeListButton);
            $('#colored').on('load', onColoredLoaded);
            $('#colorButton').on('click', onColorButton);
            $('#posterized').on('load', onPosterizedLoaded);
            $('#posterizeButton').on('click', onPosterizeButton);
            $('#autolevelButton').on('click', onAutolevelButton);
            $('#autogammaButton').on('click', onAutogammaButton);
            $('#contrastButton').on('click', onContrastButton);
            $('#sigmoidalContrastButton').on('click', onSigmoidalContrastButton);
            $('#morphologyButton').on('click', onMorphologyButton);
            $('#source').on('change', onSourceChange);
            $('main').show();
        };
        $(() => {
            $(window).on('IMReady', onIMReady);
        });
    </script>
</head>
<body>
    <main style="display: none;">
        <h1>Test WASM ImageMagick Legacy</h1>
        <h2>Source</h2>
        <p><select id="source">
            <option value="peppers.png" selected>peppers.png</option>
            <option value="lena.png">lena.png</option>
            <option value="parrot.jpg">parrot.jpg</option>
            <option value="parrots.png">parrots.png</option>
            <option value="balloons.png">balloons.png</option>
            <option value="wellexposed.png">wellexposed.png</option>
            <option value="overexposed.png">overexposed.png</option>
            <option value="underexposed.png">underexposed.png</option>
        </select></p>
        <p><img id="src" src="peppers.png" /></p>
        <h2>Resize</h2>
        <p><label for="width">Width</label> <input id="width" type="number" value="400" /> px, <label for="height">Height</label> <input id="height" type="number" value="400" /> px, <label for="filters">Filter</label> <select id="filters"></select>, <button id="resizeButton" type="button">Resize</button></p>
        <p><img id="resized" /></p>
        <h2>Charcoal</h2>
        <p><label for="charcoalRadius">Radius</label> <input id="charcoalRadius" type="number" value="2" />, <label for="charcoalSigma">Sigma</label> <input id="charcoalSigma" type="number" value="0.5" />, <button id="charcoalButton" type="button">Apply</button></p>
        <p><img id="charcoaled" /></p>
        <h2>Sketch</h2>
        <p><label for="sketchRadius">Radius</label> <input id="sketchRadius" type="number" value="15" />, <label for="sketchSigma">Sigma</label> <input id="sketchSigma" type="number" value="10" />, <label for="sketchAngle">Angle</label> <input id="sketchAngle" type="number" value="-47" />, <button id="sketchButton" type="button">Apply</button></p>
        <p><img id="sketched" /></p>
        <h2>Quantize</h2>
        <p><label for="quantizeNumber">Number of colors</label> <input id="quantizeNumber" type="number" value="8" />, 
            <label for="quantizeColorSpace">Color space</label>  <select id="quantizeColorSpace"></select>,
            <label for="quantizeTreeDepth">Tree depth</label>  <select id="quantizeTreeDepth">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>,
            <input id="quantizeDither" type="checkbox" /><label for="quantizeDither">Hilbert Curve Dither</label>,
            <input id="quantizeErrorCorrection" type="checkbox" /><label for="quantizeErrorCorrection">Error Correction</label>,
            <button id="quantizeButton" type="button">Apply</button></p>
        <p><img id="quantized" /></p>
        <h3>Palette <span id="numberColors"></span></h3>
        <p id="palette"></p>
        <h2>Quantize and list unique colors</h2>
        <p><label for="quantizeListNumber">Number of colors</label> <input id="quantizeListNumber" type="number" value="8" />,
            <button id="quantizeListButton" type="button">Apply</button></p>
        <h3>Palette <span id="quantizeListNumberColors"></span></h3>
        <p id="quantizeListPalette"></p>
        <h2>Command "-colors n"</h2>
        <p><label for="colorDither">Dither</label> <select id="colorDither"></select>, <label for="colorNumber">Number of colors</label> <input id="colorNumber" type="number" value="8" />, <button id="colorButton" type="button">Apply</button></p>
        <p><img id="colored" /></p>
        <h3>Palette <span id="colorNumberColors"></span></h3>
        <p id="colorPalette"></p>
        <h2>Posterize</h2>
        <p><label for="posterizeLevels">Levels</label> <input id="posterizeLevels" type="number" value="2" />, <button id="posterizeButton" type="button">Apply</button></p>
        <p><img id="posterized" /></p>
        <h3>Palette <span id="posterizeNumberColors"></span></h3>
        <p id="posterizePalette"></p>
        <h2>Auto level</h2>
        <p><label for="alChannels">Channel(s)</label> <select id="alChannels"></select>, <button id="autolevelButton" type="button">Apply</button></p>
        <p><img id="autoleveled" /></p>
        <h2>Auto gamma</h2>
        <p><label for="agChannels">Channel(s)</label> <select id="agChannels"></select>, <button id="autogammaButton" type="button">Apply</button></p>
        <p><img id="autogammaed" /></p>
        <h2>Contrast</h2>
        <p><input type="radio" id="contrastIncrease" name="contrastRadio" value="1" checked /><label for="contrastIncrease">Increase</label> <input type="radio" id="contrastDecrease" name="contrastRadio" value="0" /><label for="contrastDecrease">Decrease</label>, <button id="contrastButton" type="button">Apply</button></p>
        <p><img id="contrasted" /></p>
        <h2>Sigmoidal contrast</h2>
        <p><input type="radio" id="sigmoidalContrastIncrease" name="sigmoidalContrastRadio" value="1" checked /><label for="sigmoidalContrastIncrease">Increase</label> <input type="radio" id="sigmoidalContrastDecrease" name="sigmoidalContrastRadio" value="0" /><label for="sigmoidalContrastDecrease">Decrease</label>, <label for="sigmoidalContrast">Contrast</label> <input id="sigmoidalContrast" type="number" value="3" />/20, <label for="sigmoidalContrastMidPoint">Mid point</label> <input id="sigmoidalContrastMidPoint" type="number" value="50" />%, <button id="sigmoidalContrastButton" type="button">Apply</button></p>
        <p><img id="sigmoidalContrasted" /></p>
        <h2>Morphology</h2>
        <p><label for="morphologyMethod">Method</label> <select id="morphologyMethod"></select>,
            <label for="morphologyKernel">Kernel</label> <select id="morphologyKernel"></select>,
            <label for="morphologyKernelParams">Parameters</label> <select id="morphologyKernelParams"></select>,
            <button id="morphologyButton" type="button">Apply</button></p>
        <p>Kernel preview<br /><img id="kernelPreview" /></p>
        <p><img id="morphologied" /></p>
        <h2>Exposure</h2>
        <p>According to Fred Weinhaus</p>
        <p>
            <label for="exposureStops">Exposure</label> <input id="exposureStops" type="range" value="1" min="-20" max="20" step="0.01" /> <span class="fixedWidth" id="exposureStopsDisplay">1</span>,
            <label for="exposureOffset">Offset</label> <input id="exposureOffset" type="range" value="0" min="-0.5" max="0.5" step="0.01" /> <span class="fixedWidth" id="exposureOffsetDisplay">0</span>,
            <label for="exposureGamma">Gamma</label> <input id="exposureGamma" type="range" value="1" min="0.01" max="9.99" step="0.01" /> <span class="fixedWidth" id="exposureGammaDisplay">1</span>,
            <button id="exposureButton" type="button">Apply</button>
            <p><img id="exposured" /></p>
        </p>
        <h2>Glow</h2>
        <p>According to Fred Weinhaus</p>
        <label for="glowAmount">Amount</label> <input id="glowAmount" type="range" value="1.5" min="1" max="2" step="0.01" /> <span class="fixedWidth" id="glowAmountDisplay">1.5</span>,
        <label for="glowSoftening">Softening</label> <input id="glowSoftening" type="range" value="0" min="0" max="150" step="1" /> <span class="fixedWidth" id="glowSofteningDisplay">0</span>,
        <button id="glowButton" type="button">Apply</button>
        <p><img id="glowed" /></p>
    </main>
</body>
</html>