<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Image Magick Legacy</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: sans-serif;
            margin: 50px 50px 600px 50px;
        }
        input[type=number] {
            width: 60px;
            text-align: right;
        }
        input[type=radio], input[type=checkbox] {
            display: inline-block;
            margin-right: 5px;
        }
        #palette {
            line-height: 34px;
        }
        .color {
            display: inline-block;
            margin-right: 7px;
        }
        .color .square {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 1px solid white;
            vertical-align: -3px;
            margin-right: 3px;
        }
        h2 {
            border-top: 1px solid white;
            line-height: 40px;
        }
        #kernelPreview {
            border: 1px solid silver;
        }
    </style>
    <script src="imagick.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script>
        const IMEnumFilters = ['Default', 'Point', 'Box', 'Triangle', 'Hermite', 'Hanning', 'Hamming', 'Blackman', 'Gaussian', 'Quadratic', 'Cubic', 'Catrom', 'Mitchell', 'Jinc', 'Sinc', 'SincFast', 'Kaiser', 'Welsh', 'Parzen', 'Bohman', 'Bartlett', 'Lagrange', 'Lanczos', 'LanczosSharp', 'Lanczos2', 'Lanczos2Sharp', 'Robidoux', 'RobidouxSharp', 'Cosine', 'Spline', 'LanczosRadius'];
        const IMEnumColorspaces = ['Default', 'RGB', 'GRAY', 'Transparent', 'OHTA', 'Lab', 'XYZ', 'YCbCr', 'YCC', 'YIQ', 'YPbPr', 'YUV', 'CMYK', 'sRGB', 'HSB', 'HSL', 'HWB', 'Rec601Luma', 'Rec601YCbCr', 'Rec709Luma', 'Rec709YCbCr', 'Log', 'CMY', 'Luv', 'HCL', 'LCH', 'LMS', 'LCHab', 'LCHuv', 'scRGB', 'HSI', 'HSV', 'HCLp', 'YDbDr', 'xyY', 'LinearGRAY'];
        const IMEnumChannels = { 'Red': 0x0001, 'Green': 0x0002, 'Blue': 0x0004, 'RGB': 0x0007, 'Alpha': 0x0008, 'RGBA': 0x000F };
        const IMEnumDithers = {
            'None': [false, 'None', 'None'],
            'FloydSteinberg': [false, 'FloydSteinberg', 'FloydSteinberg'],
            'Riemersma': [false, 'Riemersma', 'Riemersma'],
            'threshold': [true, 'threshold', 'Threshold 1x1 (non-dither)'],
            'checks': [true, 'checks', 'Checkerboard 2x1 (dither)'],
            'o2x2': [true, 'o2x2', 'Ordered 2x2 (dispersed)'],
            'o3x3': [true, 'o3x3', 'Ordered 3x3 (dispersed)'],
            'o4x4': [true, 'o4x4', 'Ordered 4x4 (dispersed)'],
            'o8x8': [true, 'o8x8', 'Ordered 8x8 (dispersed)'],
            'h4x4a': [true, 'h4x4a', 'Halftone 4x4 (angled)'],
            'h6x6a': [true, 'h6x6a', 'Halftone 6x6 (angled)'],
            'h8x8a': [true, 'h8x8a', 'Halftone 8x8 (angled)'],
            'h4x4o': [true, 'h4x4o', 'Halftone 4x4 (orthogonal)'],
            'h6x6o': [true, 'h6x6o', 'Halftone 6x6 (orthogonal)'],
            'h8x8o': [true, 'h8x8o', 'Halftone 8x8 (orthogonal)'],
            'h16x16o': [true, 'h16x16o', 'Halftone 16x16 (orthogonal)'],
            'c5x5b': [true, 'c5x5b', 'Circles 5x5 (black)'],
            'c5x5w': [true, 'c5x5w', 'Circles 5x5 (white)'],
            'c6x6b': [true, 'c6x6b', 'Circles 6x6 (black)'],
            'c6x6w': [true, 'c6x6w', 'Circles 6x6 (white)'],
            'c7x7b': [true, 'c7x7b', 'Circles 7x7 (black)'],
            'c7x7w': [true, 'c7x7w', 'Circles 7x7 (white)'],
            'diag5x5': [true, 'diag5x5', 'Simple Diagonal Line Dither'],
            'hlines2x2': [true, 'hlines2x2', 'Horizontal Lines 2x2'],
            'hlines2x2a': [true, 'hlines2x2a', 'Horizontal Lines 2x2 (bounds adjusted)'],
            'hlines12x4': [true, 'hlines12x4', 'Horizontal Lines 12x4'],
        };
        const IMEnumMorphologies = [
            'Correlate',
            'Convolve',
            'Dilate',
            'Erode',
            'Close',
            'Open',
            'DilateIntensity',
            'ErodeIntensity',
            'CloseIntensity',
            'OpenIntensity',
            'DilateI',
            'ErodeI',
            'CloseI',
            'OpenI',
            'Smooth',
            'EdgeOut',
            'EdgeIn',
            'Edge',
            'TopHat',
            'BottomHat',
            'Hmt',
            'HitNMiss',
            'HitAndMiss',
            'Thinning',
            'Thicken',
            'Distance',
            'IterativeDistance'
        ];
        const IMEnumKernels = {
            Square: [1, 2, 3, 4],
            Diamond: [1, 2, 3, 4],
            Octagon: [1, 2, 3, 4, 5],
            Disk: ['0.5', '1.0', '1.5', '2.0', '2.5', '2.9', '3.5', '3.9', '4.3', '4.5', '5.3'],
            Plus: [1, 2, 3, 4],
            Cross: [1, 2, 3, 4],
            Ring: ['1', '1.5', '1,1.5', '2', '1,2', '1.5,2', '1,2.5', '1.5,2.5', '1.5,2.9', '2,2.5', '2,3.5', '2.5,3.5', '2.9,3.5', '3,3.5', '3,3.9', '2.5,4.3', '3.5,4.3', '3.9,4.5', '4,4.5', '4.3,4.5', '4.3,5.3'],
            Rectangle: ["2x2", "3x3", "4x2", "4", "7x3", "7x1", "7x1+1+0", "7x1+6+0"],
        };
        let _IMSetSource = ($selector) => {
            let img = $selector.get(0);
            if (img.width === 0 || img.height === 0) return [false,false];
            let canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            let ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            let imagedata = ctx.getImageData(0, 0, canvas.width, canvas.height);
            FS.writeFile('src.rgba', new Uint8Array(imagedata.data.buffer));
            return [img.width, img.height];
        };
        let _IMSetDestination = ($selector, width, height) => {
            if (!FS.analyzePath('dst.rgba').exists) return;
            let canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            let context = canvas.getContext('2d');
            context.putImageData(new ImageData(Uint8ClampedArray.from(FS.readFile('dst.rgba')), width, height), 0, 0);
            $selector.attr('src', canvas.toDataURL('image/png'));
        };
        let _IMLoadJson = () => {
            if (!FS.analyzePath('dst.json').exists) return false;
            let bytes = FS.readFile('dst.json');
            let string = new TextDecoder().decode(bytes);
            return JSON.parse(string);
        }
        let _IMClearFS = () => {
            for (file of ['src.rgba', 'dst.rgba', 'dst.json']) {
                if (FS.analyzePath(file).exists) FS.unlink(file);
            }
        };
        let IMResize = ($src, width, height, filter, $dst) => {
            const [ swidth, sheight ] = _IMSetSource($src);
            if (swidth === false) return;
            if (swidth == width && sheight == height) $dst.attr('src', $src.attr('src'));
            else { 
                if (filter === 0) {
                    if (swidth > width || sheight > height) filter = IMEnumFilters.indexOf('Lanczos');
                    else filter = IMEnumFilters.indexOf('Mitchell');
                }
                _IMResize(swidth, sheight, width, height, filter, 1.0);
                _IMSetDestination($dst, width, height);
                _IMClearFS();
            }
        };
        let IMCharcoal = ($src, radius, sigma, $dst) => {
            const [ width, height ] = _IMSetSource($src);
            if (width === false) return;
            _IMCharcoal(width, height, radius, sigma);
            _IMSetDestination($dst, width, height);
            _IMClearFS();
        }
        let IMSketch = ($src, radius, sigma, angle, $dst) => {
            const [ width, height ] = _IMSetSource($src);
            if (width === false) return;
            _IMSketch(width, height, radius, sigma, angle);
            _IMSetDestination($dst, width, height);
            _IMClearFS();
        }
        let IMQuantize = ($src, numberColors, colorspace, treedepth, dither, measure_error, $dst) => {
            const [ width, height ] = _IMSetSource($src);
            if (width === false) return;
            _IMQuantize(width, height, numberColors, colorspace, treedepth, dither, measure_error);
            _IMSetDestination($dst, width, height);
            _IMClearFS();
        }
        let IMPosterize = ($src, levels, $dst) => {
            const [ width, height ] = _IMSetSource($src);
            if (width === false) return;
            _IMPosterize(width, height, levels, true);
            _IMSetDestination($dst, width, height);
            _IMClearFS();
        }
        let IMListUniqueColors = ($src) => {
            const [ width, height ] = _IMSetSource($src);
            if (width === false) return false;
            _IMListUniqueColors(width, height);
            let json = _IMLoadJson();
            _IMClearFS();
            return json;
        }
        let IMAutoLevel = ($src, $dst, channels = IMEnumChannels.RGB) => {
            const [ width, height ] = _IMSetSource($src);
            if (width === false) return;
            _IMAutoLevel(width, height, channels);
            _IMSetDestination($dst, width, height);
            _IMClearFS();
        }
        let IMAutoGamma = ($src, $dst, channels = IMEnumChannels.RGB) => {
            const [ width, height ] = _IMSetSource($src);
            if (width === false) return;
            _IMAutoGamma(width, height, channels);
            _IMSetDestination($dst, width, height);
            _IMClearFS();
        }
        let IMContrast = ($src, $dst, increase = true) => {
            const [ width, height ] = _IMSetSource($src);
            if (width === false) return;
            _IMContrast(width, height, increase);
            _IMSetDestination($dst, width, height);
            _IMClearFS();
        }
        let IMColors = ($src, numberColors, dither, $dst) => {
            const [ width, height ] = _IMSetSource($src);
            if (width === false) return;
            _IMColors(width, height, numberColors, IMEnumDithers[dither][0], IMEnumDithers[dither][1]);
            _IMSetDestination($dst, width, height);
            _IMClearFS();
        }
        let IMMorphology = ($src, morphology, params, $dst) => {
            const [ width, height ] = _IMSetSource($src);
            if (width === false) return;
            _IMMorphology(width, height, morphology, params);
            _IMSetDestination($dst, width, height);
            _IMClearFS();
        }
        let onResizeButton = () => {
            IMResize($('#src'), $('#width').val(), $('#height').val(), IMEnumFilters.indexOf($('#filters').val()), $('#resized'));
        };
        let onCharcoalButton = () => {
            IMCharcoal($('#src'), $('#charcoalRadius').val(), $('#charcoalSigma').val(), $('#charcoaled'));
        };
        let onSketchButton = () => {
            IMSketch($('#src'), $('#sketchRadius').val(), $('#sketchSigma').val(), $('#sketchAngle').val(), $('#sketched'));
        };
        let onQuantizeButton = () => {
            IMQuantize($('#src'), $('#quantizeNumber').val(), IMEnumColorspaces.indexOf($('#quantizeColorSpace').val()), $('#quantizeTreeDepth').val(), $('#quantizeDither').is(':checked'), $('#quantizeErrorCorrection').is(':checked'), $('#quantized'));
        };
        let onQuantizedLoaded = () => {
            let colors = IMListUniqueColors($('#quantized'));
            if (!Array.isArray(colors)) return;
            $('#numberColors').text('('+colors.length+' color'+(colors.length>1?'s':'')+')');
            let $container = $('#palette');
            $container.empty();
            for (color of colors) {
                let $color = $('<span class="color" />');
                let $square = $('<span class="square" />');
                $square.css('background-color', color);
                $color.text(color);
                $color.prepend($square);
                $container.append($color);
            }
        };
        let onColorButton = () => {
            IMColors($('#src'), $('#colorNumber').val(), $('#colorDither').val(), $('#colored'));
        };
        let onColoredLoaded = () => {
            let colors = IMListUniqueColors($('#colored'));
            if (!Array.isArray(colors)) return;
            $('#colorNumberColors').text('('+colors.length+' color'+(colors.length>1?'s':'')+')');
            let $container = $('#colorPalette');
            $container.empty();
            for (color of colors) {
                let $color = $('<span class="color" />');
                let $square = $('<span class="square" />');
                $square.css('background-color', color);
                $color.text(color);
                $color.prepend($square);
                $container.append($color);
            }
        };
        let onPosterizeButton = () => {
            IMPosterize($('#src'), $('#posterizeLevels').val(), $('#posterized'));
        };
        let onPosterizedLoaded = () => {
            let colors = IMListUniqueColors($('#posterized'));
            if (!Array.isArray(colors)) return;
            $('#posterizeNumberColors').text('('+colors.length+' color'+(colors.length>1?'s':'')+')');
            let $container = $('#posterizePalette');
            $container.empty();
            for (color of colors) {
                let $color = $('<span class="color" />');
                let $square = $('<span class="square" />');
                $square.css('background-color', color);
                $color.text(color);
                $color.prepend($square);
                $container.append($color);
            }
        };
        let onAutolevelButton = () => {
            IMAutoLevel($('#src'), $('#autoleveled'), IMEnumChannels[$('#alChannels').val()]);
        };
        let onAutogammaButton = () => {
            IMAutoGamma($('#src'), $('#autogammaed'), IMEnumChannels[$('#agChannels').val()]);
        };
        let onContrastButton = () => {
            let increase = $('input[name=contrastRadio]:checked').val();
            IMContrast($('#src'), $('#contrasted'), increase);
        };
        let onSourceChange = () => {
            $('#src').attr('src', $('#source').val());
        };
        let onKernelParamsChange = () => {
            let $morphologyKernel = $('#morphologyKernel');
            let $morphologyKernelParams = $('#morphologyKernelParams');
            let $kernelPreview = $('#kernelPreview');
            $kernelPreview.attr('src', 'kernpresets/kern_' + $morphologyKernel.val() + '-' + $morphologyKernelParams.val() + '.gif');
        }
        let onKernelChange = () => {
            let $morphologyKernel = $('#morphologyKernel');
            let $morphologyKernelParams = $('#morphologyKernelParams');
            let k = $morphologyKernel.val();
            $morphologyKernelParams.empty();
            for (const params of IMEnumKernels[k]) {
                let $opt = $('<option />');
                $opt.val(params);
                $opt.text(params);
                $morphologyKernelParams.append($opt);
            }
            onKernelParamsChange();
        }
        let onMorphologyButton = () => {
            IMMorphology($('#src'), $('#morphologyMethod').val(), $('#morphologyKernel').val() + ':' +  $('#morphologyKernelParams').val(), $('#morphologied'));
        }
        let onIMReady = () => {
            _IMResize = Module.cwrap('_IMResize', null, ['number', 'number', 'number', 'number', 'number', 'number']);
            _IMCharcoal = Module.cwrap('_IMCharcoal', null, ['number', 'number', 'number', 'number']);
            _IMSketch = Module.cwrap('_IMSketch', null, ['number', 'number', 'number', 'number', 'number']);
            _IMQuantize = Module.cwrap('_IMQuantize', null, ['number', 'number', 'number', 'number', 'number', 'number', 'number']);
            _IMPosterize = Module.cwrap('_IMPosterize', null, ['number', 'number', 'number', 'number']);
            _IMListUniqueColors = Module.cwrap('_IMListUniqueColors', null, ['number', 'number']);
            _IMAutoLevel = Module.cwrap('_IMAutoLevel', null, ['number', 'number', 'number']);
            _IMAutoGamma = Module.cwrap('_IMAutoGamma', null, ['number', 'number', 'number']);
            _IMContrast = Module.cwrap('_IMContrast', null, ['number', 'number', 'number']);
            _IMColors = Module.cwrap('_IMColors', null, ['number', 'number', 'number', 'number', 'string']);
            _IMMorphology = Module.cwrap('_IMMorphology', null, ['number', 'number', 'string', 'string']);
            let $filters = $('#filters');
            const sortedFilters = [...IMEnumFilters].sort();
            for (const filter of sortedFilters) {
                let $opt = $('<option />');
                $opt.val(filter);
                $opt.text(filter);
                if (filter === 'Default') $opt.prop('selected', true);
                $filters.append($opt);
            }
            for (const channelsId of ['#alChannels', '#agChannels']) {
                let $channels = $(channelsId);
                for (channel of Object.keys(IMEnumChannels)) {
                    let $opt = $('<option />');
                    $opt.val(channel);
                    $opt.text(channel);
                    if (channel === 'RGB') $opt.prop('selected', true);
                    $channels.append($opt);
                }
            }
            let $ditherSelect = $('#colorDither');
            for (const dither of Object.keys(IMEnumDithers)) {
                let $opt = $('<option />');
                $opt.val(dither);
                $opt.text(IMEnumDithers[dither][2]);
                if (dither === 'FloydSteinberg') $opt.prop('selected', true);
                $ditherSelect.append($opt);
            }
            let $quantizeColorSpace = $('#quantizeColorSpace');
            for (const colorspace of IMEnumColorspaces) {
                let $opt = $('<option />');
                $opt.val(colorspace);
                $opt.text(colorspace);
                if (colorspace === 'sRGB') $opt.prop('selected', true);
                $quantizeColorSpace.append($opt);
            }
            let $morphologyMethod = $('#morphologyMethod');
            for (const method of IMEnumMorphologies) {
                let $opt = $('<option />');
                $opt.val(method);
                $opt.text(method);
                if (method === 'Dilate') $opt.prop('selected', true);
                $morphologyMethod.append($opt);
            }
            let $morphologyKernel = $('#morphologyKernel');
            for (const kernel of Object.keys(IMEnumKernels)) {
                let $opt = $('<option />');
                $opt.val(kernel);
                $opt.text(kernel);
                $morphologyKernel.append($opt);
                if (kernel === 'Octagon') {
                    $opt.prop('selected', true);
                    onKernelChange();
                }
            }
            $morphologyKernel.on('change', onKernelChange);
            $('#morphologyKernelParams').on('change', onKernelParamsChange);
            $('#resizeButton').on('click', onResizeButton);
            $('#charcoalButton').on('click', onCharcoalButton);
            $('#sketchButton').on('click', onSketchButton);
            $('#quantized').on('load', onQuantizedLoaded);
            $('#quantizeButton').on('click', onQuantizeButton);
            $('#colored').on('load', onColoredLoaded);
            $('#colorButton').on('click', onColorButton);
            $('#posterized').on('load', onPosterizedLoaded);
            $('#posterizeButton').on('click', onPosterizeButton);
            $('#autolevelButton').on('click', onAutolevelButton);
            $('#autogammaButton').on('click', onAutogammaButton);
            $('#contrastButton').on('click', onContrastButton);
            $('#morphologyButton').on('click', onMorphologyButton);
            $('#source').on('change', onSourceChange);
            $('main').show();
        };
        $(() => {
            $(window).on('IMReady', onIMReady);
        });
    </script>
</head>
<body>
    <main style="display: none;">
        <h1>Test WASM ImageMagick Legacy</h1>
        <h2>Source</h2>
        <p><select id="source">
            <option value="peppers.png" selected>peppers.png</option>
            <option value="lena.png">lena.png</option>
            <option value="parrot.jpg">parrot.jpg</option>
            <option value="parrots.png">parrots.png</option>
            <option value="balloons.png">balloons.png</option>
            <option value="wellexposed.png">wellexposed.png</option>
            <option value="overexposed.png">overexposed.png</option>
            <option value="underexposed.png">underexposed.png</option>
        </select></p>
        <p><img id="src" src="peppers.png" /></p>
        <h2>Resize</h2>
        <p><label for="width">Width</label> <input id="width" type="number" value="400" /> px, <label for="height">Height</label> <input id="height" type="number" value="400" /> px, <label for="filters">Filter</label> <select id="filters"></select>, <button id="resizeButton" type="button">Resize</button></p>
        <p><img id="resized" /></p>
        <h2>Charcoal</h2>
        <p><label for="charcoalRadius">Radius</label> <input id="charcoalRadius" type="number" value="2" />, <label for="charcoalSigma">Sigma</label> <input id="charcoalSigma" type="number" value="0.5" />, <button id="charcoalButton" type="button">Apply</button></p>
        <p><img id="charcoaled" /></p>
        <h2>Sketch</h2>
        <p><label for="sketchRadius">Radius</label> <input id="sketchRadius" type="number" value="15" />, <label for="sketchSigma">Sigma</label> <input id="sketchSigma" type="number" value="10" />, <label for="sketchAngle">Angle</label> <input id="sketchAngle" type="number" value="-47" />, <button id="sketchButton" type="button">Apply</button></p>
        <p><img id="sketched" /></p>
        <h2>Quantize</h2>
        <p><label for="quantizeNumber">Number of colors</label> <input id="quantizeNumber" type="number" value="8" />, 
            <label for="quantizeColorSpace">Color space</label>  <select id="quantizeColorSpace"></select>,
            <label for="quantizeTreeDepth">Tree depth</label>  <select id="quantizeTreeDepth">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>,
            <input id="quantizeDither" type="checkbox" /><label for="quantizeDither">Hilbert Curve Dither</label>,
            <input id="quantizeErrorCorrection" type="checkbox" /><label for="quantizeErrorCorrection">Error Correction</label>,
            <button id="quantizeButton" type="button">Apply</button></p>
        <p><img id="quantized" /></p>
        <h3>Palette <span id="numberColors"></span></h3>
        <p id="palette"></p>
        <h2>Command "-colors n"</h2>
        <p><label for="colorDither">Dither</label> <select id="colorDither"></select>, <label for="colorNumber">Number of colors</label> <input id="colorNumber" type="number" value="8" />, <button id="colorButton" type="button">Apply</button></p>
        <p><img id="colored" /></p>
        <h3>Palette <span id="colorNumberColors"></span></h3>
        <p id="colorPalette"></p>
        <h2>Posterize</h2>
        <p><label for="posterizeLevels">Levels</label> <input id="posterizeLevels" type="number" value="2" />, <button id="posterizeButton" type="button">Apply</button></p>
        <p><img id="posterized" /></p>
        <h3>Palette <span id="posterizeNumberColors"></span></h3>
        <p id="posterizePalette"></p>
        <h2>Auto level</h2>
        <p><label for="alChannels">Channel(s)</label> <select id="alChannels"></select>, <button id="autolevelButton" type="button">Apply</button></p>
        <p><img id="autoleveled" /></p>
        <h2>Auto gamma</h2>
        <p><label for="agChannels">Channel(s)</label> <select id="agChannels"></select>, <button id="autogammaButton" type="button">Apply</button></p>
        <p><img id="autogammaed" /></p>
        <h2>Contrast</h2>
        <p><input type="radio" id="contrastIncrease" name="contrastRadio" value="1" checked /><label for="contrastIncrease">Increase</label> <input type="radio" id="contrastDecrease" name="contrastRadio" value="0" /><label for="contrastDecrease">Decrease</label>, <button id="contrastButton" type="button">Apply</button></p>
        <p><img id="contrasted" /></p>
        <h2>Morphology</h2>
        <p><label for="morphologyMethod">Method</label> <select id="morphologyMethod"></select>,
            <label for="morphologyKernel">Kernel</label> <select id="morphologyKernel"></select>,
            <label for="morphologyKernelParams">Parameters</label> <select id="morphologyKernelParams"></select>,
            <button id="morphologyButton" type="button">Apply</button></p>
        <p>Kernel preview<br /><img id="kernelPreview" /></p>
        <p><img id="morphologied" /></p>
    </main>
</body>
</html>